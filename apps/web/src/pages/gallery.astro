---
import Layout from "@layouts/Layout.astro";
import { listStorageRecords } from "@services/database";

const cache = Astro.locals.runtime.env.CACHE;
let cachedStorageRecords = await cache.get("storage_records");
console.log("cachedStorageRecords", cachedStorageRecords);
if (!cachedStorageRecords) {
  const storageRecords = await listStorageRecords(Astro.locals.dbClient);
  await cache.put("storage_records", JSON.stringify(storageRecords));
  cachedStorageRecords = JSON.stringify(storageRecords);
}
const records = JSON.parse(cachedStorageRecords) as Awaited<
  ReturnType<typeof listStorageRecords>
>;
---

<Layout>
  <div class="container">
    <div class="text-center">
      <h1>The Gallery</h1>
      <p class="alert">The gallery resets in every 5 minutes!</p>
      <p><a href="/upload">Click here to upload new picture →</a></p>
    </div>
    <div class="masonry">
      {
        records.map((record) => (
          <img src={`/cdn/${record.key}`} alt={record.originalName} />
        ))
      }
    </div>
  </div>
</Layout>

<style>
  a {
    color: #6100ee;
    font-weight: bold;
  }
  .container {
    padding: 2rem;
  }
  .text-center {
    text-align: center;
    margin-bottom: 2rem;
  }
  .alert {
    color: maroon;
    font-weight: bold;
  }
  .masonry {
    column-count: 1; /* Default: 1 column on very small screens */
    column-gap: 1rem; /* Gutter size */
  }

  /* Make images fill the column’s width, with bottom margin as vertical spacing */
  .masonry img {
    width: 100%;
    display: block;
    margin-bottom: 1rem;
    border-radius: 4px; /* optional styling */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  /* At >= 600px: 2 columns */
  @media (min-width: 600px) {
    .masonry {
      column-count: 2;
    }
  }

  /* At >= 900px: 3 columns */
  @media (min-width: 900px) {
    .masonry {
      column-count: 3;
    }
  }

  /* At >= 1200px: 4 columns */
  @media (min-width: 1200px) {
    .masonry {
      column-count: 4;
    }
  }

  /* At >= 1500px: 5 columns */
  @media (min-width: 1500px) {
    .masonry {
      column-count: 5;
    }
  }
</style>
